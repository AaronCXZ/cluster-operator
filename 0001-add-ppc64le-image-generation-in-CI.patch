From e18062310ce61d7b3c1b2863037208196205d465 Mon Sep 17 00:00:00 2001
From: Sapana Khemkar <Sapana.Khemkar@ibm.com>
Date: Thu, 3 Aug 2023 10:00:14 +0000
Subject: [PATCH] add ppc64le image generation in CI

---
 .github/workflows/build-test-publish.yml | 27 ++++++++++++++++++++++--
 1 file changed, 25 insertions(+), 2 deletions(-)

diff --git a/.github/workflows/build-test-publish.yml b/.github/workflows/build-test-publish.yml
index 20a116a..5c51212 100644
--- a/.github/workflows/build-test-publish.yml
+++ b/.github/workflows/build-test-publish.yml
@@ -106,7 +106,7 @@ jobs:
       uses: docker/build-push-action@v3
       with:
         context: .
-        platforms: linux/amd64, linux/arm64
+        platforms: linux/amd64, linux/arm64, linux/ppc64le
         push: ${{ github.event_name != 'pull_request' }}
         tags: ${{ steps.meta.outputs.tags }}
         labels: ${{ steps.meta.outputs.labels }}
@@ -155,7 +155,30 @@ jobs:
         platforms: linux/arm64
         push: ${{ github.event_name != 'pull_request' }}
         tags: ${{ steps.single-arch-meta-arm64.outputs.tags }}
-        labels: ${{ steps.single-arch-meta-arm64.outputs.labels }}     
+        labels: ${{ steps.single-arch-meta-arm64.outputs.labels }}  
+    - name: OCI Metadata for single-arch ppc64le image
+      #if: startsWith(github.ref, 'refs/tags/v')
+      id: single-arch-meta-ppc64le
+      uses: docker/metadata-action@v4
+      with:
+        # list of Docker images to use as base name for tags
+        images: |
+          rabbitmqoperator/cluster-operator
+        flavor: |
+          latest=false
+        # generate Docker tags based on the following events/attributes
+        tags: |
+          type=semver,pattern={{version}},suffix=-ppc64le,latest=false
+          type=sha,suffix=-ppc64le,latest=false
+    - name: Build and push single-arch ppc64le image
+      #if: startsWith(github.ref, 'refs/tags/v')
+      uses: docker/build-push-action@v3
+      with:
+        context: .
+        platforms: linux/ppc64le
+        push: ${{ github.event_name != 'pull_request' }}
+        tags: ${{ steps.single-arch-meta-ppc64le.outputs.tags }}
+        labels: ${{ steps.single-arch-meta-ppc64le.outputs.labels }}   
     - name: Build manifest
       if: github.event_name != 'pull_request'
       env:
-- 
2.25.1

